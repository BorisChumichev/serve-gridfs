# serve-gridfs 

### Middleware to serve static files using mongodb gridfs


Based on [serve-static](https://github.com/expressjs/serve-static)



Tested on node 7.x, npm 4.x

Require [node-mongodb-native 2.2.x](https://github.com/mongodb/node-mongodb-native)

### Install
```shell
$ npm i serve-gridfs
```

### API

```js
import serveGridfs from 'serve-gridfs'

```
#### serveGridfs(mongoConnection, { options }))
Create a new middleware function to serve files from mongodb gridfs. The file to be served is based on `req.url`. In a default setting, when a file is not found, this middleware call `next()`, instead of returning `404`, to be in line with the express [serve-static](https://github.com/expressjs/serve-static) middleware. 

#### mongoConnection

Internally, this middleware use promised based mongo client, so pass in the connection detail here.

`const mongoConnection = MongoClient.connect('mongodb://localhost:27017/myApp')`

#### Options

All options are optional

|Key | Type | Default  | Note
|--- | --- | --- | --- |
|bucketName | string | 'fs' | Default set by mongodb
|chunkSizeBytes | number | 261120 | 255 * 1024
|writeConcern | object | null ||
|readPreference | object | null ||
|||||
|acceptRanges | bool | true | Setting to `false` will not send `Accept-Ranges` and ignore the contents of the `Range` request header
|cacheControl | bool or string | true | Setting to `false` will disable the `Cache-Control` in a response header
|maxAge | number | 0 | Set this to whatever you like in seconds
|etag | bool | true | md5 generated by mongodb gridfs
|lastModified | bool | true | 
|fallthrough | bool | true | If set to `false`, a `next(new Error('FileNotFound))` will be called when a file specified in req.url cannot be found
|setHeaders | function | null | signature `function (res, path, stat) {}`. `path` is the requested file path, the `stat` is the stat of the file if present, produced by mongodb fs.files, typically, it is `{ _id, length, chuckSize, uploadDate, md5, filename }`, see [uploadStream](http://mongodb.github.io/node-mongodb-native/2.2/api/GridFSBucket.html#openUploadStream)


Example

```js
// with express js

import express from 'express'
import { MongoClient, GridFSBucket } from 'mongodb'
import serveGridfs from 'serve-gridfs'

const app = express()
const mongoConnection = MongoClient.connect('mongodb://localhost:27017/myApp')

app.use('/uploads', serveGridfs(mongoConnection))

const options = {
  bucketName: 'somethingElse',
  setHeaders(res, path, stat) {
    if (stat && stat.contentType === 'application/pdf' && stat.length > 102400000) res.setHeader('Content-Disposition', 'attachment; filename = ' + path)
  }
}
app.use('/uploads2', serveGridfs(mongoConnection, { bucketName: 'somethingElse' }))

```

